<!DOCTYPE html>
<html>
<head>
    <meta charset=utf-8 />
    <title>Mercury - BRC Off-Grid Friend Finder</title>
    <script src='https://api.tiles.mapbox.com/mapbox.js/v2.2.4/mapbox.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox.js/v2.2.4/mapbox.css' rel='stylesheet' />
    <script src="http://code.jquery.com/jquery-1.8.3.min.js" type="text/javascript"></script>
    <style>
        body { margin:0; padding:0; }
        .map { top:0; bottom:0; width:100%;height:80%; }
    </style>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        var socket = io();
        
    </script>
</head>
<body>
	<div style="position:absolute; top:0; bottom:0; width:480px;height:320px; ">
		<div id='map-one' class='map' >
		</div>
		<div id="controls" style="float: bottom;width:100%; height: 100%;">
			<div>
				<button id="set_bmOffset" onclick="set_bmOffset()">BM Center 2015</button>
			</div>
			<div>
				<button id="reset_location" onclick="reset_location()">Current Localtion</button>
			</div>
		</div> 
	</div>
	<script type="text/javascript">
        var globalData;
        socket.on('data', function(data){
            console.log(data);
            globalData = data;
            if(bmOffset){
                var lat = data.lat + latOffset
                var lon = data.lon + lonOffset
            }
            else{
                var lat = data.lat
                var lon = data.lon
            }
            myLayer.on('layeradd', function(e) {
                var marker = e.layer,
                    feature = marker.feature;
                    marker.setLatLng([lat,lon])
                    marker.setIcon(L.icon(feature.properties.icon));
            });
            myLayer.setGeoJSON(geojson);
            mapOne.setView([lat,lon]);
        });
		//move your current GPS cordinates to the center of BRC 2015
		var bmOffset = false;
		document.getElementById("set_bmOffset").addEventListener("click", set_bmOffset);
		//off set to relate current cordinates to center BM 2015
		var latOffset = 0;
		var lonOffset = 0;
		function set_bmOffset() {	
			bmOffset = true;
			latOffset =  40.78640000000001 - globalData.lat;
			lonOffset =  -119.2065 - globalData.lon;
			console.log(latOffset);
			console.log(lonOffset);
            lat = globalData.lat + latOffset
            lon = globalData.lon + lonOffset
            myLayer.on('layeradd', function(e) {
            var marker = e.layer,
                feature = marker.feature;
                marker.setLatLng([lat,lon])
                marker.setIcon(L.icon(feature.properties.icon));
            });
            myLayer.setGeoJSON(geojson);
            mapOne.setView([lat,lon]);
		}
		function reset_location() {	
			bmOffset = false;
			latOffset =  0;
			lonOffset =  0;
		}
		//var bmOffset = false;
		//move BRC 2015 cordinates to your current location
		var bmOverlay = false;
		
		//create map
		L.mapbox.accessToken = 'pk.eyJ1IjoibXVmZmluc2F1cnVzcmV4IiwiYSI6ImNpbnVuaDFvcjExeHJ1Mm0zbnczZXFtNWMifQ.EvWoIv6R42b2rQdPBhe3TA';
		var mapOne = L.mapbox.map(
            'map-one', 'mapbox.streets'
        );
		mapOne.setView([0,0], 13);
        
		var myLayer = L.mapbox.featureLayer().addTo(mapOne);
		mapOne.scrollWheelZoom.disable();
		//create marker properties
		var geojson = [{
			"type": "Feature",
			"geometry": {
				"type": "Point",
				"coordinates": [0,0]
			},
			"properties": {
				"icon": {
					"iconUrl": "/markers/jpoindexter.jpg",
					"iconSize": [15, 15], // size of the icon
					"iconAnchor": [5, 5], // point of the icon which will correspond to marker's location
					"popupAnchor": [0, 0], // point from which the popup should open relative to the iconAnchor
					"className": "dot"
				}
			}
		}];
		//overlay BM streets
		var featureLayer = L.mapbox.featureLayer()
			.loadURL('/bm15/streets.json')
			.addTo(mapOne); 

	</script>
</body>
</html>
